# v3.0 Release Specification: Roadmap-Generator Command

> **Version**: 1.0 | **Generated**: 2026-01-06 | **Status**: DRAFT

## Executive Summary

This release delivers the second custom command for the IBOpenCode framework: `/rf:roadmap-gen`. The command generates deterministic, file-driven release roadmap packages from specification documents, with integrated cross-model upgrade via `/rf:crossLLM`.

**Key Deliverables**:
1. `/rf:roadmap-gen` command with 9-phase pipeline
2. Roadmap-gen orchestrator agent
3. Template evaluation system with 3 starter templates
4. Standardized crossLLM Integration Protocol (reusable for future commands)
5. Supporting agents for domain-specific extraction and validation

---

## 1. Problem Statement

### Current State
- Release planning requires manual document creation
- No standardized roadmap format across projects
- Generated content lacks multi-model quality assurance
- No reusable pattern for integrating crossLLM into other commands

### Desired State
- Single command generates complete roadmap package from specification
- Standardized, deterministic output format
- Automatic quality upgrade via crossLLM adversarial debate
- Modular integration protocol reusable by all future commands

---

## 2. Scope

### In Scope
| Item | Description |
|------|-------------|
| Command definition | `/rf:roadmap-gen` with full syntax and routing |
| Orchestrator agent | 9-phase pipeline execution |
| Template system | 3 starter templates with section-based overlays |
| crossLLM integration | Post-generation upgrade phase with consistency validation |
| Integration protocol | Standardized pattern for future commands |
| Documentation | User guide and technical specification |

### Out of Scope
| Item | Rationale |
|------|-----------|
| Modifying crossLLM internals | Strict modularity requirement |
| GUI/web interface | CLI-first framework |
| Real-time collaboration | Single-user execution model |
| External project management integration | Future enhancement |

---

## 3. Requirements

### 3.1 Functional Requirements

#### FR-001: Command Invocation
**Description**: User invokes roadmap generation via command interface

**Acceptance Criteria**:
```gherkin
Given a valid specification file exists at <path>
When user invokes "/rf:roadmap-gen <version> <path>"
Then the command validates inputs before creating any artifacts
And generates 4 required artifacts under ".roadmaps/<version>/"
```

**Syntax**:
```
/rf:roadmap-gen <input_spec_path> [options]

Options:
  --chain <model_chain>       Model chain for upgrade (default: claude>gpt)
  --no-upgrade                Skip upgrade phase entirely
  --upgrade-only <artifacts>  Comma-separated artifact list to upgrade
  --upgrade-threshold <N>     Minimum improvement % to accept (default: 25)
  --version <N>               Number of upgrade iterations (default: 2)
  --parallel-upgrades         Upgrade artifacts in parallel (default: true)
  --sequential-upgrades       Force sequential upgrades (debugging)
  --output <dir>              Custom output directory
```

**--version Flag Behavior**:
The `--version` flag controls the number of upgrade iterations, NOT a target version number:

```pseudocode
IF --no-upgrade OR --version 1:
    # Draft only - no upgrades
    Phase 7 skipped
    Output: v1/ folder with draft artifacts

ELSE IF --version 2 (default when --version not specified):
    # Single upgrade iteration
    Draft → crossLLM(claude>gpt) → v2
    Output: v1/ (drafts) + v2/ (upgraded)

ELSE IF --version 3:
    # Two upgrade iterations (sequential model chains)
    Draft → crossLLM(claude>gpt) → crossLLM(gpt>gemini) → v3
    Output: v1/ (drafts) + v2/ (first upgrade) + v3/ (second upgrade)
    Note: Each iteration uses a different chain segment

ELSE IF --version N (N > 3):
    # N-1 upgrade iterations
    Chains cycle through: claude>gpt, gpt>gemini, gemini>claude, ...
```

**Multi-Iteration Chain Cycling**:
Since crossLLM supports only 2-model chains, multi-iteration upgrades run sequential crossLLM invocations:
- Iteration 1: `claude>gpt` (or custom via `--chain`)
- Iteration 2: `gpt>gemini`
- Iteration 3: `gemini>claude`
- Iteration 4+: Cycle repeats

**Note**: If `--chain` is specified, it overrides iteration 1 only. Subsequent iterations continue the default cycle starting from the second model in the specified chain.

**Version Management**:
- Version 1 = Initial draft generation (always created)
- Version 2+ = Upgraded versions via crossLLM iterations
- Versions are artifact versions, NOT command versions (no backward compatibility needed)

**Examples**:
```bash
# Generate draft only (v1), no upgrades
/rf:roadmap-gen ./spec.md --version 1
# Equivalent to:
/rf:roadmap-gen ./spec.md --no-upgrade

# Generate draft + single upgrade (v1 → v2) - DEFAULT
/rf:roadmap-gen ./spec.md
# Equivalent to:
/rf:roadmap-gen ./spec.md --version 2

# Generate draft + two upgrades (v1 → v2 → v3)
/rf:roadmap-gen ./spec.md --version 3
# Chain sequence: claude>gpt (v1→v2), then gpt>gemini (v2→v3)

# Lower threshold for experimental upgrades
/rf:roadmap-gen ./spec.md --upgrade-threshold 15

# Force sequential upgrades (for debugging)
/rf:roadmap-gen ./spec.md --sequential-upgrades

# Upgrade specific artifacts only
/rf:roadmap-gen ./spec.md --upgrade-only roadmap.md,test-strategy.md
```

#### FR-002: 9-Phase Pipeline Execution
**Description**: Command executes deterministic 9-phase pipeline

**Phases**:
| Phase | Name | Output |
|-------|------|--------|
| 0 | Preflight Validation | Pass/Fail gate |
| 1 | Input Extraction | `extraction.md` |
| 2 | Persona Selection | Documented in roadmap metadata |
| 2.5 | Template Evaluation | Template selection or variant creation |
| 3 | Roadmap Construction | `roadmap.md` (using selected template) |
| 4 | Test Strategy | `test-strategy.md` |
| 5 | Execution Prompt | `execution-prompt.md` |
| 6 | Self-Validation | Traceability verification |
| 7 | Content Upgrade | Upgraded artifacts via crossLLM (parallel) |
| 7.5 | Cross-Artifact Consistency | Verify upgraded artifacts remain consistent |

#### FR-002.5: Template Evaluation System
**Description**: Select optimal template based on extraction and persona context using section-based overlays

**Template Architecture**:
All templates share a common base structure with optional sections that activate based on release type:

```
┌─────────────────────────────────────────────────────────────┐
│                    Common Base Sections                      │
│  • Executive Summary     • Success Criteria                 │
│  • Milestone Structure   • Dependency Map                   │
│  • Risk Register         • Resource Allocation              │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ feature-      │  │ quality-      │  │ documentation-│
│ release.md    │  │ release.md    │  │ release.md    │
├───────────────┤  ├───────────────┤  ├───────────────┤
│ + Feature     │  │ + Test        │  │ + Content     │
│   Breakdown   │  │   Coverage    │  │   Structure   │
│ + API Changes │  │   Matrix      │  │ + Migration   │
│ + Migration   │  │ + Performance │  │   Guide       │
│   Notes       │  │   Benchmarks  │  │ + Cross-refs  │
│ + Deprecation │  │ + Security    │  │ + Version     │
│   Warnings    │  │   Checklist   │  │   History     │
└───────────────┘  └───────────────┘  └───────────────┘
```

**Starter Templates**:
| Template | Primary Use Case | Key Sections |
|----------|------------------|--------------|
| `feature-release.md` | New features, enhancements, API additions | Feature breakdown, API changes, migration notes, deprecations |
| `quality-release.md` | Testing, performance, security improvements | Test coverage matrix, performance benchmarks, security checklist |
| `documentation-release.md` | Documentation refactors, reorganization | Content structure, migration guide, cross-references, version history |

**Acceptance Criteria**:
```gherkin
Given Phase 1 (extraction) and Phase 2 (persona) are complete
When Phase 2.5 (Template Evaluation) executes
Then the system:
  | Step | Action |
  | 1 | Loads candidate templates from .opencode/resources/templates/roadmaps/ |
  | 2 | Scores each template against extraction content + persona |
  | 3 | If best_score >= 80%: Select that template |
  | 4 | If best_score < 80%: Create variant from best template |
  | 5 | Document template selection rationale in template-selection.md |
```

**Template Selection** (scoring criteria determined during development via CoT):
- Scoring algorithm and weights will be designed using Sequential Thinking MCP
- Core factors: domain alignment, structure fit, complexity match
- Threshold: 80% compatibility required for direct template use

**Template Variant Creation** (when no template scores ≥80%):
1. Start with highest-scoring template as base
2. Identify gaps between template and current needs
3. Activate/deactivate optional sections to address gaps
4. Preserve framework consistency patterns
5. Save variant to `.opencode/resources/templates/roadmaps/variants/`
6. Log creation rationale for future template improvements

#### FR-003: crossLLM Integration
**Description**: Generated artifacts are upgraded via cross-model debate

**Acceptance Criteria**:
```gherkin
Given Phase 1-6 completed successfully
And --no-upgrade flag is NOT present
When Phase 7 executes
Then for each upgradeable artifact:
  | Step | Action |
  | 1 | Copy artifact to artifact.draft.md |
  | 2 | Invoke /rf:crossLLM v2 file <chain> <artifact_path> |
  | 3 | If PASS: Replace artifact with upgrade.md content |
  | 4 | If FAIL: Keep original draft, log warning |
And upgrade-log.md contains all upgrade results
```

#### FR-004: Artifact Preservation
**Description**: Original drafts preserved for audit and rollback

**Acceptance Criteria**:
- Before upgrade: `roadmap.md` → `roadmap.draft.md`
- Draft files retained until explicit cleanup
- Upgrade log provides traceability

#### FR-005: Graceful Degradation
**Description**: Upgrade failures don't block roadmap generation

**Acceptance Criteria**:
- Failed upgrades keep original artifact unchanged
- Pipeline continues processing remaining artifacts
- Circuit breaker triggers if ≥50% artifacts fail

#### FR-006: Cross-Artifact Consistency Validation (Phase 7.5)
**Description**: After parallel upgrades, validate that upgraded artifacts remain internally consistent

**Rationale**:
When `roadmap.md`, `test-strategy.md`, and `execution-prompt.md` are upgraded in parallel, each upgrade operates independently. The upgraded `roadmap.md` might introduce new milestones or restructure deliverables that the `test-strategy.md` and `execution-prompt.md` don't reflect.

**Acceptance Criteria**:
```gherkin
Given Phase 7 (parallel upgrades) has completed
When Phase 7.5 (consistency validation) executes
Then the system validates:
  | Check | Description |
  | 1 | All roadmap deliverables have corresponding test coverage |
  | 2 | Execution-prompt references valid milestone/deliverable IDs |
  | 3 | No orphaned references in test-strategy or execution-prompt |
  | 4 | Milestone ordering consistent across all artifacts |
And if inconsistencies detected:
  | Action | Severity |
  | Log warning with specifics | Minor (naming differences) |
  | Flag for manual review | Moderate (missing coverage) |
  | Trigger targeted re-upgrade | Major (structural mismatch) |
```

**Consistency Checks**:
1. **ID Reference Integrity**: All IDs in test-strategy and execution-prompt exist in roadmap
2. **Coverage Completeness**: All roadmap deliverables mapped to test scenarios
3. **Structural Alignment**: Milestone hierarchy consistent across artifacts
4. **Naming Consistency**: Deliverable names match between artifacts (allow minor variations)

**Output**: `consistency-report.md` in version folder documenting any findings

### 3.2 Non-Functional Requirements

#### NFR-001: Modularity
**Description**: crossLLM functionality remains isolated

**Constraints**:
- roadmap-gen MUST NOT import crossLLM agent code
- roadmap-gen MUST NOT duplicate crossLLM logic
- Integration via command invocation ONLY
- crossLLM interface contract is the ONLY dependency

#### NFR-002: Determinism
**Description**: Same inputs produce same outputs

**Constraints**:
- Ordering rules explicit and deterministic
- ID assignment follows defined scheme
- No randomization in artifact structure

#### NFR-003: Performance
**Description**: Reasonable execution time

**Targets**:
| Operation | Target |
|-----------|--------|
| Phase 1-6 (generation) | < 3 minutes |
| Phase 7 per artifact | < 5 minutes |
| Phase 7.5 (consistency check) | < 30 seconds |
| Total pipeline (4 artifacts, --version 2) | < 25 minutes |

#### NFR-004: Extensibility
**Description**: Pattern reusable for future commands

**Constraints**:
- Integration protocol documented and version-controlled
- Protocol independent of roadmap-gen specifics
- Clear interface contract for any command

---

## 4. Architecture

### 4.1 Component Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         /rf:roadmap-gen                             │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   Command Router                               │  │
│  │  • Validates syntax                                           │  │
│  │  • Parses options (--chain, --version, --output, etc.)       │  │
│  │  • Routes to orchestrator                                     │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              @rf-roadmap-gen-orchestrator                      │  │
│  │                                                                │  │
│  │  Phase 0: Preflight Validation                                │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 1: Input Extraction → extraction.md                    │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 2: Persona Selection → metadata                        │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 2.5: Template Evaluation ← @rf-roadmap-gen-template-scorer │
│  │      │       • Score templates against extraction + persona   │  │
│  │      │       • If best ≥80%: Use template                    │  │
│  │      │       • If best <80%: Create variant                  │  │
│  │      ▼                                                        │  │
│  │  Phase 3: Roadmap Construction → roadmap.md (using template)  │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 4: Test Strategy → test-strategy.md                    │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 5: Execution Prompt → execution-prompt.md              │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 6: Self-Validation (traceability check)                │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 7: crossLLM Integration (PARALLEL)                     │  │
│  │      │                                                        │  │
│  │      ├──► /rf:crossLLM v2 file <chain> roadmap.md            │  │
│  │      ├──► /rf:crossLLM v2 file <chain> test-strategy.md      │  │
│  │      └──► /rf:crossLLM v2 file <chain> execution-prompt.md   │  │
│  │                    (all 3 run in parallel)                    │  │
│  │      │                                                        │  │
│  │      ▼                                                        │  │
│  │  Phase 7.5: Cross-Artifact Consistency Validation             │  │
│  │      • Verify upgraded artifacts remain internally consistent │  │
│  │      • Check ID references, coverage, structural alignment    │  │
│  │      • Output: consistency-report.md                          │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ Command Invocation (Black Box)
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         /rf:crossLLM                                │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  • Proposers (3)      • Judge agent                           │  │
│  │  • Debate agent       • QAG Evaluator                         │  │
│  │  • Grounding system   • Domain detector                       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  Output: .dev/runs/rf-crossLLM/<runId>/                             │
│  • upgrade.md (final content)                                       │
│  • scorecard.md (PASS/FAIL result)                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 Interface Contract

**roadmap-gen → crossLLM Interface**:

| Aspect | Specification |
|--------|---------------|
| Invocation | `/rf:crossLLM v2 file <chain> <artifact_path>` |
| Input | Any `.md` file in `.roadmaps/<version>/` |
| Output Location | `.dev/runs/rf-crossLLM/<runId>/` |
| Success File | `upgrade.md` |
| Result File | `scorecard.md` |
| Success Indicator | `scorecard.md` contains `Result: PASS` |
| Failure Indicator | `scorecard.md` contains `Result: FAIL` |

**roadmap-gen DOES NOT access**:
- `proposals/` folder
- `debate.md`
- `judgement.md`
- Internal scoring mechanics
- Any crossLLM agent definitions

### 4.3 File Structure

```
.opencode/
├── resources/
│   └── templates/
│       └── roadmaps/                        # Roadmap templates
│           ├── feature-release.md           # Feature/enhancement releases
│           ├── quality-release.md           # QA/testing/performance releases
│           ├── documentation-release.md     # Documentation refactors
│           └── variants/                    # Auto-generated variants
│               └── feature-release-v1.md    # Created when no template fits

.roadmaps/
├── my-release/                         # Version-named output folder
│   ├── v1/                             # Version 1 (initial draft)
│   │   ├── extraction.md
│   │   ├── roadmap.md
│   │   ├── test-strategy.md
│   │   ├── execution-prompt.md
│   │   └── template-selection.md       # Phase 2.5 output
│   │
│   ├── v2/                             # Version 2 (upgraded via claude>gpt)
│   │   ├── extraction.md               # Copied from v1 (not upgraded)
│   │   ├── roadmap.md                  # Upgraded
│   │   ├── roadmap.draft.md            # Pre-upgrade copy
│   │   ├── test-strategy.md            # Upgraded
│   │   ├── test-strategy.draft.md
│   │   ├── execution-prompt.md         # Upgraded
│   │   ├── execution-prompt.draft.md
│   │   ├── template-selection.md       # Copied from v1
│   │   ├── upgrade-log.md              # Phase 7 results
│   │   └── consistency-report.md       # Phase 7.5 results
│   │
│   └── v3/                             # Version 3 (second upgrade via gpt>gemini)
│       └── ...                         # Same structure as v2

.dev/runs/rf-crossLLM/
└── 20260106-143022__file__claude>gpt/  # Per-artifact upgrade run
    ├── input.md
    ├── proposals/
    ├── debate.md
    ├── judgement.md
    ├── upgrade.md                      # ← roadmap-gen copies this on PASS
    └── scorecard.md                    # ← roadmap-gen checks this for result
```

### 4.4 Version Management

**Version Naming Convention**:
- `v1` — Initial draft (always created)
- `v2`, `v3`, `v4`... — Sequential upgrade iterations
- Version number = upgrade iteration count + 1 (v1=draft, v2=1 upgrade, v3=2 upgrades)

**Version Iteration Model**:
```
--version 1:    v1 (draft only)

--version 2:    v1 (draft) ──[claude>gpt]──► v2

--version 3:    v1 (draft) ──[claude>gpt]──► v2 ──[gpt>gemini]──► v3

--version 4:    v1 ──[claude>gpt]──► v2 ──[gpt>gemini]──► v3 ──[gemini>claude]──► v4
```

**Chain Cycling**: Each iteration uses the next chain in sequence:
1. `claude>gpt` → 2. `gpt>gemini` → 3. `gemini>claude` → (repeat)

**Output Folder Naming**:
- Default: Derived from input spec filename (e.g., `spec.md` → `.roadmaps/spec/`)
- Custom: Use `--output <dir>` to specify folder name

**Upgrade Chain Tracking**:
Each version's `upgrade-log.md` includes:
- Source version (e.g., v1 for v2 creation)
- Chain used for this iteration
- Timestamp
- Per-artifact results

---

## 5. crossLLM Integration Protocol

### 5.1 Protocol Version
**Version**: 1.0
**Status**: Draft
**Applicability**: All IBOpenCode commands generating `.md` artifacts

### 5.2 Integration Steps

```pseudocode
FUNCTION integrate_crossLLM(artifact_path, chain, timeout_minutes=5):

    # Step 1: Preserve original
    draft_path = artifact_path.replace('.md', '.draft.md')
    COPY artifact_path → draft_path

    # Step 2: Invoke crossLLM
    result = INVOKE "/rf:crossLLM v2 file {chain} {artifact_path}"

    # Step 3: Handle timeout
    IF result.duration > timeout_minutes:
        LOG "UPGRADE-TIMEOUT: {artifact_path}"
        RETURN { status: "TIMEOUT", artifact: draft_path }

    # Step 4: Parse result
    run_folder = result.run_folder  # e.g., .dev/runs/rf-crossLLM/20260106-.../
    scorecard_path = "{run_folder}/scorecard.md"
    upgrade_path = "{run_folder}/upgrade.md"

    IF NOT EXISTS(scorecard_path):
        LOG "UPGRADE-UNVERIFIED: {artifact_path}"
        RETURN { status: "UNVERIFIED", artifact: draft_path }

    scorecard_content = READ(scorecard_path)

    # Step 5: Check pass/fail
    IF "Result: PASS" IN scorecard_content:
        COPY upgrade_path → artifact_path
        LOG "UPGRADED: {artifact_path}"
        RETURN { status: "PASS", artifact: artifact_path, run_folder: run_folder }
    ELSE:
        LOG "UPGRADE-FAILED: {artifact_path}"
        RETURN { status: "FAIL", artifact: draft_path, run_folder: run_folder }
```

### 5.3 Circuit Breaker

```pseudocode
FUNCTION upgrade_with_circuit_breaker(artifacts, chain):
    results = []
    failure_count = 0
    failure_threshold = CEIL(LEN(artifacts) / 2)

    FOR artifact IN artifacts:
        result = integrate_crossLLM(artifact, chain)
        results.APPEND(result)

        IF result.status IN ["FAIL", "TIMEOUT", "UNVERIFIED"]:
            failure_count += 1

        IF failure_count >= failure_threshold:
            LOG "CIRCUIT BREAKER: {failure_count}/{LEN(artifacts)} failures"
            LOG "Stopping upgrades. All remaining artifacts will use drafts."
            BREAK

    RETURN results
```

### 5.4 Upgrade Log Format

```markdown
# Upgrade Log: [VERSION]

## Configuration
- **Chain**: claude>gpt
- **Timestamp**: 2026-01-06T14:30:22Z
- **Circuit Breaker Threshold**: 2 failures

## Results

| Artifact | Status | Improvement | Run Folder |
|----------|--------|-------------|------------|
| roadmap.md | ✅ PASS | +32% | `.dev/runs/rf-crossLLM/20260106-143022__file__claude>gpt/` |
| test-strategy.md | ✅ PASS | +28% | `.dev/runs/rf-crossLLM/20260106-143145__file__claude>gpt/` |
| execution-prompt.md | ❌ FAIL | +18% | `.dev/runs/rf-crossLLM/20260106-143301__file__claude>gpt/` |

## Summary
- **Upgraded**: 2/3 artifacts
- **Retained as Draft**: 1/3 artifacts
- **Circuit Breaker**: Not triggered
```

---

## 6. Agent Specifications

### 6.1 Command Definition

**File**: `.opencode/command/rf:roadmap-gen.md`

```markdown
---
description: Generate release roadmap with crossLLM upgrade
---

You are executing `/rf:roadmap-gen`.

Args: `$ARGUMENTS`

## Syntax
```
/rf:roadmap-gen <input_spec_path> [options]
```

## Parameters
| Parameter | Required | Description |
|-----------|----------|-------------|
| `<input_spec_path>` | Yes | Path to specification file |
| `--version <N>` | No | Number of upgrade iterations (default: 2) |
| `--chain <chain>` | No | Model chain for first iteration (default: `claude>gpt`) |
| `--no-upgrade` | No | Skip Phase 7 and 7.5 (equivalent to --version 1) |
| `--upgrade-only <list>` | No | Artifacts to upgrade (comma-separated) |
| `--parallel-upgrades` | No | Upgrade artifacts in parallel (default: true) |
| `--sequential-upgrades` | No | Force sequential upgrades (for debugging) |
| `--output <dir>` | No | Custom output directory name |

## Routing
Invoke `@rf-roadmap-gen-orchestrator`

## Validation
If arguments invalid: print usage and STOP.
```

### 6.2 Orchestrator Agent

**File**: `.opencode/agent/rf-roadmap-gen-orchestrator.md`

**Core Responsibilities**:
1. Validate inputs (preflight checks)
2. Execute Phase 1-6 (draft generation)
3. Execute Phase 7 (crossLLM integration)
4. Execute Phase 7.5 (cross-artifact consistency validation)
5. Handle failures gracefully
6. Produce upgrade log and consistency report

**Model**: `gpt-5.2` (same as crossLLM orchestrator for consistency)
**Temperature**: `0.1` (deterministic)
**Tools**: bash, read, write, edit, list, glob, grep, task

### 6.3 Template Scorer Agent (Required)

**File**: `.opencode/agent/rf-roadmap-gen-template-scorer.md`

**Purpose**: Score templates against extraction + persona context for Phase 2.5

**Model**: `claude-sonnet-4-5` (good at structured comparison)
**Temperature**: `0.1` (deterministic scoring)
**Tools**: read, glob (read-only, no write access)

**Input Contract**:
```yaml
extraction_content: string    # Content from extraction.md
persona: string               # Selected primary persona
consulting_personas: list     # Secondary personas
domain_distribution: object   # Domain percentages from Phase 2
templates_path: string        # .opencode/resources/templates/roadmaps/
```

**Output Contract**:
```yaml
scores:
  - template: "feature-release.md"
    score: 85                      # 0-100 scale
    recommendation: "USE"          # USE | VARIANT_CANDIDATE
    rationale: "Explanation..."

selected_template:
  path: ".opencode/resources/templates/roadmaps/feature-release.md"
  action: "USE" | "CREATE_VARIANT"
  sections_to_activate: []         # Optional sections to enable
  sections_to_deactivate: []       # Optional sections to disable
```

**Scoring Approach** (detailed algorithm designed during development):
- Use Sequential Thinking MCP to design and refine scoring criteria
- Core evaluation factors: domain alignment, structure fit, complexity match
- Threshold: 80% compatibility required for direct template use
- Scoring weights and algorithm to be documented in agent prompt during implementation

### 6.4 Supporting Agents (Optional Enhancement)

| Agent | Purpose | Priority |
|-------|---------|----------|
| `@rf-roadmap-gen-extractor` | Structured input parsing | P2 |
| `@rf-roadmap-gen-validator` | Cross-artifact consistency | P2 |

---

## 7. Test Strategy

### 7.1 Unit Tests

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| Valid simple spec | Single-feature spec | 4 artifacts created |
| Missing input file | Invalid path | STOP with error |
| Empty spec | No actionable items | STOP with clarification request |
| Version folder exists | Existing folder, no --force | STOP with error |
| Version folder exists with --force | Existing folder | Overwrite |

### 7.2 Integration Tests

| Test Case | Scenario | Expected Behavior |
|-----------|----------|-------------------|
| Full pipeline | Valid spec, default chain | All 9 phases complete |
| Upgrade PASS | crossLLM returns PASS | Artifact replaced with upgrade |
| Upgrade FAIL | crossLLM returns FAIL | Draft preserved, warning logged |
| Circuit breaker | 2/3 artifacts fail | Upgrades stopped, user alerted |
| --no-upgrade | Flag present | Phase 7 and 7.5 skipped |
| --version 1 | Draft only requested | Only v1 folder created, no upgrades |
| Parallel upgrades | 3 artifacts | All 3 upgrade in parallel |
| Multi-iteration | --version 3 | Two sequential upgrade rounds (v1→v2→v3) |
| Consistency validation | After parallel upgrades | Phase 7.5 generates consistency-report.md |

### 7.2.5 Template System Tests

| Test Case | Scenario | Expected Behavior |
|-----------|----------|-------------------|
| Feature template match | Feature-heavy spec (new APIs, enhancements) | `feature-release.md` selected |
| Quality template match | QA/performance/security spec | `quality-release.md` selected |
| Documentation template match | Documentation refactor spec | `documentation-release.md` selected |
| Template match <80% | Mixed-domain spec | Variant created from best template |
| No templates exist | Empty template directory | Use default inline template |
| Variant creation | Best template scores 72% | Variant saved to variants/ folder |
| Section activation | Feature spec with security concerns | Feature template with security section activated |

### 7.2.6 Cross-Artifact Consistency Tests

| Test Case | Scenario | Expected Behavior |
|-----------|----------|-------------------|
| All consistent | Parallel upgrades maintain ID references | Pass, no warnings in consistency-report.md |
| Missing coverage | Upgraded roadmap has deliverable not in test-strategy | Warning logged, flagged for manual review |
| Orphaned reference | Execution-prompt references deleted milestone | Error logged, targeted re-upgrade triggered |
| Naming drift | Minor naming differences between artifacts | Warning logged, documented in report |

### 7.3 Acceptance Criteria Verification

Each artifact must pass self-validation:
- `extraction.md`: All items have unique IDs, valid types, valid priorities
- `roadmap.md`: All extraction items appear exactly once in milestones
- `test-strategy.md`: All deliverables have test coverage assigned
- `execution-prompt.md`: All paths reference valid artifacts

---

## 8. Implementation Roadmap

### Milestone 1: Foundation
- [ ] Create command definition file
- [ ] Create orchestrator agent skeleton
- [ ] Implement preflight validation
- [ ] Implement Phase 1 (extraction)

### Milestone 2: Template System
- [ ] Create 3 starter templates (feature-release, quality-release, documentation-release)
- [ ] Implement Phase 2 (persona selection)
- [ ] Implement Phase 2.5 (template evaluation)
- [ ] Create template scorer agent with CoT-designed scoring criteria

### Milestone 3: Core Generation
- [ ] Implement Phase 3 (roadmap construction using templates)
- [ ] Implement Phase 4 (test strategy)
- [ ] Implement Phase 5 (execution prompt)
- [ ] Implement Phase 6 (self-validation)

### Milestone 4: crossLLM Integration
- [ ] Implement Integration Protocol
- [ ] Implement Phase 7 (parallel upgrades)
- [ ] Implement Phase 7.5 (cross-artifact consistency validation)
- [ ] Implement circuit breaker
- [ ] Implement upgrade log and consistency report generation

### Milestone 5: Documentation & Testing
- [ ] Create user documentation
- [ ] Create technical documentation
- [ ] Execute test strategy
- [ ] Validate all acceptance criteria

---

## 9. Risk Register

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| crossLLM API changes | Low | High | Version-lock interface contract |
| Upgrade threshold too strict | Medium | Medium | Consider configurable threshold |
| Large specs cause timeout | Medium | Medium | Chunking strategy for Phase 1 |
| Model availability issues | Low | High | Fallback to --no-upgrade |

---

## 10. Success Criteria

| Criterion | Measure | Target |
|-----------|---------|--------|
| Command functional | All phases execute | 100% |
| Modularity maintained | No crossLLM code imported | 0 imports |
| Upgrade success rate | Artifacts pass crossLLM | ≥75% |
| Documentation complete | User + Tech docs | 100% |
| Tests passing | All test cases | 100% |

---

## Appendix A: Example Invocations

```bash
# Generate draft + single upgrade (default: --version 2)
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md

# Generate draft only, no upgrades
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --version 1
# Equivalent to:
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --no-upgrade

# Generate with 3 upgrade iterations (v1 → v2 → v3 → v4)
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --version 4

# Custom first-iteration chain (subsequent iterations still cycle)
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --chain gpt>claude

# Upgrade only specific artifacts
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --upgrade-only roadmap.md,test-strategy.md

# Custom output directory
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --output my-release

# Sequential upgrades for debugging
/rf:roadmap-gen .dev/plans/v3.0_Roadmaps/spec.md --sequential-upgrades
```

---

## Appendix B: Related Documentation

| Document | Purpose |
|----------|---------|
| [crossLLM User Guide](./Commands/crossLLM_UserDoc.md) | crossLLM usage reference |
| [crossLLM Technical Spec](./Commands/crossLLM_TD.md) | crossLLM architecture |
| [Integration Protocol](./crossLLM-Integration-Protocol.md) | Reusable integration pattern |

---

*Generated by /sc:spec-panel | Part of IBOpenCode Documentation Suite*
