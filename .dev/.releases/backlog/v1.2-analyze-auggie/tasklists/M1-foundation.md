# Tasklist: M1 - Foundation - MCP Integration Fix

## Metadata
- **Milestone**: M1
- **Dependencies**: None
- **Estimated Complexity**: Medium
- **Risk Level**: HIGH (R9: missing directory_path causes failures)
- **Duration**: Week 1

---

## Tasks

### T1.1: Fix MCP Tool Name
**Type**: FEATURE
**Priority**: P0-Critical
**Files Affected**:
- `src/superclaude/commands/analyze.md`

#### Steps
1. Search for all occurrences of Auggie MCP references in analyze command
2. Replace any incorrect tool names with `mcp__auggie-mcp__codebase-retrieval`
3. Verify no legacy references to "auggie-mcp" remain
4. Update any documentation referencing the tool name

#### Acceptance Criteria
- [ ] All Auggie MCP calls use exact name: `mcp__auggie-mcp__codebase-retrieval`
- [ ] No occurrences of "auggie-mcp" without full prefix
- [ ] Tool invocation syntax matches MCP protocol

#### Verification
```bash
# Check for correct tool name
grep -r "mcp__auggie-mcp__codebase-retrieval" src/superclaude/commands/

# Check for incorrect references (should return nothing)
grep -r "auggie-mcp" src/superclaude/commands/ | grep -v "mcp__auggie-mcp"
```

---

### T1.2: Add Required directory_path Parameter
**Type**: FEATURE
**Priority**: P0-Critical
**Files Affected**:
- `src/superclaude/commands/analyze.md`

#### Steps
1. Identify all Auggie MCP invocations in analyze command
2. Add `directory_path` as REQUIRED parameter to each invocation
3. Implement project root auto-detection logic
4. Add validation to ensure directory_path is never null/empty
5. Add error handling for invalid paths

#### Acceptance Criteria
- [ ] Every Auggie call includes `directory_path` parameter
- [ ] Parameter uses absolute path to project root
- [ ] Auto-detection works for git repositories
- [ ] Clear error message if path invalid

#### Implementation Pattern
```yaml
# CORRECT - All Auggie calls must follow this pattern
tool: mcp__auggie-mcp__codebase-retrieval
parameters:
  directory_path: "/absolute/path/to/project"  # REQUIRED
  information_request: "semantic query here"
```

#### Verification
```bash
# Check directory_path is always present
grep -A 5 "mcp__auggie-mcp__codebase-retrieval" src/superclaude/commands/analyze.md | grep "directory_path"
```

---

### T1.3: Basic Circuit Breaker Implementation
**Type**: FEATURE
**Priority**: P0-Critical
**Files Affected**:
- `src/superclaude/commands/analyze.md`

#### Steps
1. Define circuit breaker configuration for Auggie MCP
2. Implement failure tracking (3 failures threshold)
3. Implement timeout handling (30s timeout)
4. Implement state transitions (CLOSED → OPEN → HALF_OPEN → CLOSED)
5. Implement fallback to native tools (Glob + Grep)
6. Add recovery mechanism (half-open after 60s)

#### Acceptance Criteria
- [ ] Circuit opens after 3 consecutive failures
- [ ] Timeout triggers after 30 seconds
- [ ] Fallback to Glob + Grep when circuit open
- [ ] Half-open state tested after 60s
- [ ] User notified when in fallback mode

#### Circuit Breaker Configuration
```yaml
circuit_breaker:
  auggie_circuit:
    failure_threshold: 3
    timeout: 30s
    fallback: "Native Glob + Grep discovery"
    user_message: "⚠️ Semantic search circuit open - using pattern matching"
    recovery: "Half-open after 60s"
```

#### State Transition Diagram
```
         ┌───────────────────────────────────────┐
         │                CLOSED                  │
         │  (Normal operation, requests pass)     │
         └──────────────────┬────────────────────┘
                            │
                  3 failures │
                            ▼
         ┌───────────────────────────────────────┐
         │                 OPEN                   │
         │  (Fallback active, block requests)    │
         └──────────────────┬────────────────────┘
                            │
                  60s timeout │
                            ▼
         ┌───────────────────────────────────────┐
         │              HALF_OPEN                 │
         │  (Test request, decide next state)    │
         └────────┬────────────────────┬─────────┘
                  │                    │
           success │                   │ failure
                  ▼                    ▼
              CLOSED                 OPEN
```

#### Verification
```bash
# Run circuit breaker tests
uv run pytest tests/analyze/test_mcp_integration.py::test_circuit_breaker -v
```

---

## Milestone Completion Checklist

- [ ] T1.1: Fix MCP Tool Name - completed
- [ ] T1.2: Add Required directory_path Parameter - completed
- [ ] T1.3: Basic Circuit Breaker Implementation - completed
- [ ] All verification commands pass
- [ ] No regressions in existing functionality
- [ ] Memory checkpoint saved

## Checkpoint Command
```
mcp__serena__write_memory("analyze-auggie-m1", {
  status: "completed",
  deliverables: ["M1-D1", "M1-D2", "M1-D3"],
  issues: [],
  verified: true
})
```

---

*Tasklist M1 - Generated by SuperClaude Roadmap Generator v1.0*
